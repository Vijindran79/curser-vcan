// subscription.ts// subscription.ts

// Simplified Stripe Payment Link Implementation// Simplified Stripe Payment Link Implementation



import { State } from './state';import { State } from './state';

import { showToast } from './ui';import { showToast } from './ui';

import { mountService } from './router';import { mountService } from './router';



/**/**

 * Direct Payment Links for subscriptions (no backend required) * Direct Payment Links for subscriptions (no backend required)

 */ */

const SUBSCRIPTION_PAYMENT_LINKS = {const SUBSCRIPTION_PAYMENT_LINKS = {

    monthly: {    monthly: {

        amount: 999, // $9.99 in cents        amount: 999, // $9.99 in cents

        url: 'https://buy.stripe.com/6oU8wR9uDb0gayL6gv7Vm00', // Pro Monthly Payment Link        url: 'https://buy.stripe.com/6oU8wR9uDb0gayL6gv7Vm00', // Pro Monthly Payment Link

        label: '$9.99/month'        label: '$9.99/month'

    },    },

    yearly: {    yearly: {

        amount: 9900, // $99.00 in cents        amount: 9900, // $99.00 in cents

        url: 'https://buy.stripe.com/3cI4g8fgX36kdKXgV97Vm01', // Pro Yearly Payment Link        url: 'https://buy.stripe.com/3cI4g8fgX36kdKXgV97Vm01', // Pro Yearly Payment Link

        label: '$99/year'        label: '$99/year'

    }    }

} as const;} as const;



/**/**

 * Initialize subscription checkout using Stripe Payment Links * Initialize subscription checkout using Stripe Payment Links

 */ */

function initializeCheckout(plan: 'monthly' | 'yearly') {function initializeCheckout(plan: 'monthly' | 'yearly') {

    if (!State.isLoggedIn || !State.currentUser) {    if (!State.isLoggedIn || !State.currentUser) {

        showToast('üîí Please sign in first to subscribe', 'error');        showToast('üîí Please sign in first to subscribe', 'error');

        mountService('auth');        mountService('auth');

        return;        return;

    }    }

        

    try {    try {

        console.log('[SUBSCRIPTION] Redirecting to payment link for plan:', plan);        console.log('[SUBSCRIPTION] Redirecting to payment link for plan:', plan);

        console.log('[SUBSCRIPTION] User:', State.currentUser?.email);        console.log('[SUBSCRIPTION] User:', State.currentUser?.email);

                

        // Simple redirect to Stripe-hosted checkout        // Simple redirect to Stripe-hosted checkout

        window.location.href = SUBSCRIPTION_PAYMENT_LINKS[plan].url;        window.location.href = SUBSCRIPTION_PAYMENT_LINKS[plan].url;

    } catch (error) {    } catch (error) {

        console.error('Checkout error:', error);        console.error('Checkout error:', error);

        showToast('Failed to open checkout. Please try again.', 'error');        showToast('Failed to open checkout. Please try again.', 'error');

    }    }

}}

            };

/**            script.onerror = () => {

 * Render the subscription page UI                console.warn = originalWarn; // Restore on error

 */                resolve(); // Don't reject - allow app to continue

export function renderSubscriptionPage() {            };

    const isPro = State.user?.subscription?.status === 'active';            document.head.appendChild(script);

            });

    return `    } catch (error) {

        <div class="subscription-container">        // Don't throw - allow app to continue

            <h2>Choose Your Plan</h2>    }

            }

            <div class="pricing-cards">

                <div class="pricing-card monthly">/**

                    <h3>Monthly Pro</h3> * Render subscription pricing page

                    <div class="price">${SUBSCRIPTION_PAYMENT_LINKS.monthly.label}</div> */

                    <button onclick="window.location.href='${SUBSCRIPTION_PAYMENT_LINKS.monthly.url}'" ${isPro ? 'disabled' : ''}>export function renderSubscriptionPage(): string {

                        ${isPro ? 'Current Plan' : 'Subscribe Monthly'}    const currentTier = State.subscriptionTier;

                    </button>    const isPro = currentTier === 'pro';

                </div>    

                    return `

                <div class="pricing-card yearly">        <div class="subscription-page">

                    <h3>Yearly Pro</h3>            <button class="back-btn" onclick="mountService('landing')">‚Üê Back to Home</button>

                    <div class="price">${SUBSCRIPTION_PAYMENT_LINKS.yearly.label}</div>            

                    <div class="savings">Save 17% (2 months free)</div>            <div class="subscription-header">

                    <button onclick="window.location.href='${SUBSCRIPTION_PAYMENT_LINKS.yearly.url}'" ${isPro ? 'disabled' : ''}>                <h1>Upgrade to Pro</h1>

                        ${isPro ? 'Current Plan' : 'Subscribe Yearly'}                <p class="subtitle">Get unlimited container shipping quotes & premium features</p>

                    </button>            </div>

                </div>            

            </div>            <div class="pricing-cards">

                <!-- Monthly Plan -->

            ${isPro ? `                <div class="pricing-card ${!isPro ? 'recommended' : ''}">

                <div class="current-plan-notice">                    <div class="pricing-badge">Most Popular</div>

                    <i class="fa-solid fa-check-circle"></i>                    <h3>Monthly</h3>

                    <p>You're currently on the <strong>Pro Plan</strong>. Thank you for your subscription!</p>                    <div class="price">

                </div>                        <span class="currency">${State.currentCurrency.symbol}</span>

            ` : `                        <span class="amount">9.99</span>

                <div class="free-tier-info">                        <span class="period">/month</span>

                    <h3>Free Tier Includes:</h3>                    </div>

                    <ul>                    <ul class="features">

                        <li>‚úì Basic container quotes</li>                        <li><i class="fa-solid fa-check"></i> Unlimited FCL container quotes</li>

                        <li>‚úì Standard rate estimates</li>                        <li><i class="fa-solid fa-check"></i> Live rates from major carriers</li>

                        <li>‚úì Limited monthly quotes</li>                        <li><i class="fa-solid fa-check"></i> Instant quote comparisons</li>

                        <li>‚úì Essential booking features</li>                        <li><i class="fa-solid fa-check"></i> Priority customer support</li>

                    </ul>                        <li><i class="fa-solid fa-check"></i> Advanced booking features</li>

                    <p class="upgrade-cta">Upgrade to Pro for unlimited real-time container rates & instant quotes!</p>                        <li><i class="fa-solid fa-check"></i> Cancel anytime</li>

                </div>                    </ul>

            `}                    <button 

                                    class="main-submit-btn ${isPro ? 'disabled' : ''}" 

            <div class="pricing-faq">                        id="subscribe-monthly-btn"

                <h3>Frequently Asked Questions</h3>                        ${isPro ? 'disabled' : ''}

                <div class="faq-item">                    >

                    <h4>Can I cancel anytime?</h4>                        ${isPro ? 'Current Plan' : 'Subscribe Monthly'}

                    <p>Yes! Cancel your subscription anytime from your account settings. No hidden fees.</p>                    </button>

                </div>                </div>

                <div class="faq-item">                

                    <h4>What payment methods do you accept?</h4>                <!-- Yearly Plan -->

                    <p>We accept all major credit cards, debit cards, and digital wallets via Stripe.</p>                <div class="pricing-card ${!isPro ? 'best-value' : ''}">

                </div>                    <div class="pricing-badge savings">Save 17%</div>

                <div class="faq-item">                    <h3>Yearly</h3>

                    <h4>Will I lose access if I cancel?</h4>                    <div class="price">

                    <p>You'll have access until the end of your billing period. After that, you'll revert to the free tier.</p>                        <span class="currency">${State.currentCurrency.symbol}</span>

                </div>                        <span class="amount">99</span>

            </div>                        <span class="period">/year</span>

        </div>                    </div>

    `;                    <div class="savings-badge">Save $20.88 annually</div>

}                    <ul class="features">
                        <li><i class="fa-solid fa-check"></i> Everything in Monthly</li>
                        <li><i class="fa-solid fa-check"></i> <strong>17% discount</strong></li>
                        <li><i class="fa-solid fa-check"></i> Best value for regular shippers</li>
                    </ul>
                    <button 
                        class="main-submit-btn ${isPro ? 'disabled' : ''}" 
                        id="subscribe-yearly-btn"
                        ${isPro ? 'disabled' : ''}
                    >
                        ${isPro ? 'Current Plan' : 'Subscribe Yearly'}
                    </button>
                </div>
            </div>
            
            ${isPro ? `
                <div class="current-plan-notice">
                    <i class="fa-solid fa-check-circle"></i>
                    <p>You're currently on the <strong>Pro Plan</strong>. Thank you for your subscription!</p>
                </div>
            ` : `
                <div class="free-tier-info">
                    <h3>Free Tier Includes:</h3>
                    <ul>
                        <li>‚úì Basic container quotes</li>
                        <li>‚úì Standard rate estimates</li>
                        <li>‚úì Limited monthly quotes</li>
                        <li>‚úì Essential booking features</li>
                    </ul>
                    <p class="upgrade-cta">Upgrade to Pro for unlimited real-time container rates & instant quotes!</p>
                </div>
            `}
            
            <div class="pricing-faq">
                <h3>Frequently Asked Questions</h3>
                <div class="faq-item">
                    <h4>Can I cancel anytime?</h4>
                    <p>Yes! Cancel your subscription anytime from your account settings. No hidden fees.</p>
                </div>
                <div class="faq-item">
                    <h4>What payment methods do you accept?</h4>
                    <p>We accept all major credit cards, debit cards, and digital wallets via Stripe.</p>
                </div>
                <div class="faq-item">
                    <h4>Will I lose access if I cancel?</h4>
                    <p>You'll have access until the end of your billing period. After that, you'll revert to the free tier.</p>
                </div>
            </div>
        </div>
    `;
}

/**
 * Initialize subscription checkout
 * Uses Stripe Checkout API directly (no Firebase Functions - avoids CORS!)
 */
function initializeCheckout(plan: 'monthly' | 'yearly') {
    // User should be logged in to track subscription
    if (!State.isLoggedIn || !State.currentUser) {
        showToast('üîí Please sign in first to subscribe', 'error');
        mountService('auth');
        return;
    }
    
    toggleLoading(true, 'Opening secure checkout...');
    
    try {
        console.log('[SUBSCRIPTION] Starting checkout for plan:', plan);
        console.log('[SUBSCRIPTION] User:', State.currentUser?.email);
        
        // Redirect to the appropriate Stripe Payment Link
        window.location.href = SUBSCRIPTION_PAYMENT_LINKS[plan].url;
        
        // No need for error handling here - simple redirect
        window.location.href = SUBSCRIPTION_PAYMENT_LINKS[plan].url;
    } catch (error: any) {
        console.error('Checkout error:', error);
        showToast('Failed to open checkout. Please try again.', 'error');
        
        showToast(errorMessage, 'error', 8000);
        toggleLoading(false);
    }
}

/**
 * Check subscription status from Firestore
 */
export async function checkSubscriptionStatus(): Promise<void> {
    if (!State.isLoggedIn || !State.currentUser?.email) {
        return;
    }
    
    try {
        if (!db) {
            console.warn('Firestore not initialized');
            return;
        }
        
        const userDoc = await db.collection('users').doc(State.currentUser.email).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            const subscriptionTier = userData?.subscriptionTier || 'free';
            const subscriptionExpiry = userData?.subscriptionExpiry?.toDate();
            
            // Check if subscription is still active
            if (subscriptionTier === 'pro' && subscriptionExpiry && subscriptionExpiry > new Date()) {
                setState({ subscriptionTier: 'pro' });
            } else {
                setState({ subscriptionTier: 'free' });
            }
        }
    } catch (error) {
        console.error('Error checking subscription:', error);
        // Don't throw - just log the error
    }
}

/**
 * Cancel subscription
 */
export async function cancelSubscription(): Promise<void> {
    if (!State.isLoggedIn) {
        showToast('Please sign in', 'error');
        return;
    }
    
    if (!confirm('Are you sure you want to cancel your subscription? You\'ll have access until the end of your billing period.')) {
        return;
    }
    
    toggleLoading(true, 'Cancelling subscription...');
    
    try {
        if (!functions) {
            throw new Error('Functions not available');
        }
        
        const cancelSubscriptionFn = functions?.httpsCallable('cancelSubscription');
        
        if (!cancelSubscriptionFn) {
            throw new Error('Cancellation system not ready. Please refresh the page.');
        }
        
        await cancelSubscriptionFn({});
        
        setState({ subscriptionTier: 'free' });
        showToast('Subscription cancelled successfully', 'success');
        
        // Update UI
        const page = document.getElementById('page-subscription');
        if (page) {
            page.innerHTML = renderSubscriptionPage();
            attachSubscriptionListeners();
        }
    } catch (error: any) {
        console.error('Cancel subscription error:', error);
        showToast(error.message || 'Failed to cancel subscription', 'error');
    } finally {
        toggleLoading(false);
    }
}

/**
 * Attach event listeners for subscription page
 */
export function attachSubscriptionListeners() {
    document.getElementById('subscribe-monthly-btn')?.addEventListener('click', () => initializeCheckout('monthly'));
    document.getElementById('subscribe-yearly-btn')?.addEventListener('click', () => initializeCheckout('yearly'));
}

/**
 * Initialize subscription system
 */
export async function initializeSubscription() {
    try {
        await loadStripe();
    } catch (error) {
        // Stripe loading is optional - fail silently
    }
    
    try {
        await checkSubscriptionStatus();
    } catch (error) {
        // Subscription check is optional - fail silently
    }
}

